<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Smart Drive Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
  body{height:100vh;display:flex;flex-direction:column;}
  #map{flex:1;}
  .info-panel{
    background:#fff;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.2);
    position:absolute;top:10px;left:10px;z-index:1000;border-radius:12px;
    width:230px;font-size:14px;line-height:1.6;
  }
  .info-panel h3{text-align:center;margin-bottom:6px;}
  .highlight{font-weight:bold;color:#1e88e5;}
  .set-destination{
    position:absolute;bottom:15px;left:50%;transform:translateX(-50%);
    background:#1e88e5;color:#fff;border:none;padding:10px 20px;border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);font-size:15px;cursor:pointer;
  }
  .set-destination:hover{background:#1565c0;}
</style>
</head>
<body>

<div id="map"></div>

<div class="info-panel">
  <h3>üöó Speed Meter</h3>
  <div>Speed: <span id="currentSpeed" class="highlight">0.000</span> km/h</div>
  <div>Max Speed: <span id="maxSpeed" class="highlight">0.000</span> km/h</div>
  <div>Avg Speed: <span id="avgSpeed" class="highlight">0.000</span> km/h</div>
  <hr>
  <div>ETA: <span id="eta" class="highlight">--:--</span></div>
</div>

<button class="set-destination" onclick="setDestination()">üìç Set Destination</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

<script>
const username = "Sobuj";
const speedLimit = 60;
let carMarker, routeControl;
let prevLatLng = null;
let totalSpeed = 0, updates = 0, maxSpeed = 0;
let alertPlaying = false;
let startTime = null;
let destination = null;
let etaDisplay = document.getElementById("eta");

const map = L.map('map').setView([23.8103, 90.4125], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const carIcon = L.icon({
  iconUrl: "https://i.postimg.cc/3xn9Sd08/car.png",
  iconSize: [40,40],
  iconAnchor: [20,20]
});

if(navigator.geolocation){
  navigator.geolocation.watchPosition(updatePosition, err=>{
    alert("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®!");
  }, {enableHighAccuracy:true});
}

function updatePosition(pos){
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;
  const speed = pos.coords.speed ? pos.coords.speed * 3.6 : 0;
  const currentLatLng = L.latLng(lat, lng);

  if(!startTime) startTime = Date.now();
  if(!carMarker){
    carMarker = L.marker(currentLatLng,{icon:carIcon}).addTo(map);
    map.setView(currentLatLng,16);
  }else{
    carMarker.setLatLng(currentLatLng);
  }

  updates++;
  totalSpeed += speed;
  maxSpeed = Math.max(maxSpeed, speed);
  const avgSpeed = totalSpeed / updates;
  document.getElementById("currentSpeed").innerText = speed.toFixed(3);
  document.getElementById("maxSpeed").innerText = maxSpeed.toFixed(3);
  document.getElementById("avgSpeed").innerText = avgSpeed.toFixed(3);

  // Overspeed alert
  if(speed > speedLimit && !alertPlaying){
    alertPlaying = true;
    speakBangla(`‡¶è‡¶á ${username}, ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶∞ ‡¶∏‡ßç‡¶™‡¶ø‡¶° ‡¶ï‡¶Æ‡¶æ‡¶ì!`);
    let repeat = setInterval(()=>{
      if(speed > speedLimit){
        speakBangla(`‡¶è‡¶á ${username}, ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶∞ ‡¶∏‡ßç‡¶™‡¶ø‡¶° ‡¶ï‡¶Æ‡¶æ‡¶ì!`);
      } else {
        clearInterval(repeat);
        alertPlaying = false;
      }
    }, 2500);
  }

  // ETA auto-update
  if(destination){
    const dist = currentLatLng.distanceTo(destination)/1000;
    const etaMin = speed>5 ? dist/(speed/60):0;
    if(etaMin>0){
      const etaTime = new Date(Date.now() + etaMin*60000);
      const hrs = etaTime.getHours().toString().padStart(2,'0');
      const mins = etaTime.getMinutes().toString().padStart(2,'0');
      etaDisplay.innerText = `${hrs}:${mins}`;
    }
  }

  prevLatLng = currentLatLng;
}

function speakBangla(text){
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = "bn-BD";
  msg.rate = 0.9;
  msg.pitch = 1;
  window.speechSynthesis.speak(msg);
}

// ‚úÖ Set destination + find shortest route
function setDestination(){
  alert("üó∫ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶Ø‡ßá‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶ö‡¶æ‡¶ì ‡¶∏‡ßá‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßã!");
  map.once('click', function(e){
    destination = e.latlng;
    if(routeControl) map.removeControl(routeControl);
    routeControl = L.Routing.control({
      waypoints: [carMarker.getLatLng(), destination],
      router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
      routeWhileDragging: false,
      lineOptions: {
        styles: [{color:'#1e88e5',opacity:0.8,weight:5}]
      },
      show: false,
      createMarker: ()=>null
    }).addTo(map);
  });
}
</script>
</body>
</html>
