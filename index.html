<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live AI Navigator</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css" />
<style>
body { margin:0; font-family:sans-serif; background:#111; color:#fff; }
.container { max-width:480px; margin:15px auto; padding:10px; background:rgba(0,0,0,0.6); border-radius:15px; }
input, button { width:90%; padding:10px; margin:6px 0; border-radius:8px; border:none; font-size:16px; }
button { background:#00b4d8; color:#fff; cursor:pointer; transition:0.3s; }
button:hover{background:#0096c7;}
#speed { font-size:36px; color:#0f0; margin:10px 0; }
.info { font-size:14px; margin:2px 0; }
#map { width:100%; height:300px; border-radius:10px; margin-top:10px; }
#graph { width:100%; height:100px; background:rgba(255,255,255,0.1); border-radius:8px; position:relative; overflow:hidden; margin-top:10px;}
.bar { position:absolute; bottom:0; width:3px; background:#0f0; }
</style>
</head>
<body>
<h2 style="text-align:center">🚗 Live AI Navigator</h2>
<div class="container">
  <input type="text" id="username" placeholder="তোমার নাম">
  <input type="number" id="speedLimit" placeholder="Speed Limit km/h">
  <button id="startBtn">Start Navigation</button>
  <div id="speed">0.000 km/h</div>
  <div class="info" id="maxAvg">Max: 0.000 | Avg: 0.000</div>
  <div class="info" id="distance">Distance: 0.00 km</div>
  <div class="info" id="eta">ETA: —</div>
  <div class="info" id="directionText">Direction: —</div>
  <div id="map"></div>
  <div id="graph"></div>
  <button id="resetBtn">Reset</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>
<script>
// Leaflet map
const map = L.map('map').fitWorld();
let userMarker = null;
let carIcon = L.icon({iconUrl:'https://i.postimg.cc/3xn9Sd08/car.png', iconSize:[32,32], iconAnchor:[16,16]});
let routeLine = null;
let destinationLatLng = null;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map);

// Variables
let speed=0, maxSpeed=0, avgSpeed=0, totalSpeed=0, count=0, distance=0;
let speedLimit=60, userName="";
let alertActive=false;
let bars=[];
const speedDisplay=document.getElementById("speed");
const maxAvg=document.getElementById("maxAvg");
const distanceDisplay=document.getElementById("distance");
const etaDisplay=document.getElementById("eta");
const directionText=document.getElementById("directionText");
const graph=document.getElementById("graph");

// Start Navigation
document.getElementById("startBtn").addEventListener("click",()=>{
  userName=document.getElementById("username").value.trim();
  speedLimit=parseFloat(document.getElementById("speedLimit").value)||60;
  if(!navigator.geolocation){alert("GPS not supported"); return;}
  navigator.geolocation.watchPosition(updatePosition,{enableHighAccuracy:true});
});

// Reset
document.getElementById("resetBtn").addEventListener("click",()=>{
  speed=0; maxSpeed=0; avgSpeed=0; totalSpeed=0; count=0; distance=0;
  alertActive=false;
  bars.forEach(b=>graph.removeChild(b)); bars=[];
  if(routeLine) map.removeLayer(routeLine); routeLine=null;
  if(userMarker) map.removeLayer(userMarker); userMarker=null;
  destinationLatLng=null;
  updateDisplay();
});

// Update Position
function updatePosition(pos){
  const lat=pos.coords.latitude;
  const lon=pos.coords.longitude;
  const timestamp=pos.timestamp;
  if(userMarker) userMarker.setLatLng([lat,lon]);
  else userMarker=L.marker([lat,lon],{icon:carIcon}).addTo(map).bindPopup("You");
  map.setView([lat,lon],16);

  // Calculate speed
  if(updatePosition.lastLatLng){
    const dist=getDistance(updatePosition.lastLatLng.lat,updatePosition.lastLatLng.lon,lat,lon);
    const dt=(timestamp-updatePosition.lastTime)/1000;
    speed=(dt>0)? dist/(dt/3600) : 0;
    distance+=dist;
    totalSpeed+=speed; count++; avgSpeed=totalSpeed/count;
    if(speed>maxSpeed) maxSpeed=speed;
    drawGraph(speed);
    if(speed>speedLimit && !alertActive){alertActive=true; speedAlert();}
    else if(speed<=speedLimit) alertActive=false;
  }
  updateDisplay();
  updatePosition.lastLatLng={lat,lon};
  updatePosition.lastTime=timestamp;
}

// Haversine distance
function getDistance(lat1,lon1,lat2,lon2){
  const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

// Update Display
function updateDisplay(){
  speedDisplay.textContent=speed.toFixed(3)+" km/h";
  maxAvg.textContent=`Max: ${maxSpeed.toFixed(3)} | Avg: ${avgSpeed.toFixed(3)}`;
  distanceDisplay.textContent=`Distance: ${distance.toFixed(2)} km`;
  if(destinationLatLng && speed>0){
    const remaining=getDistance(updatePosition.lastLatLng.lat,updatePosition.lastLatLng.lon,destinationLatLng.lat,destinationLatLng.lon);
    const etaMins=remaining/speed*60;
    etaDisplay.textContent=`ETA: ${etaMins.toFixed(1)} min`;
  } else etaDisplay.textContent="ETA: —";
}

// Speed Alert
function speedAlert(){
  const msg=new SpeechSynthesisUtterance(`এই ${userName||"ড্রাইভার"}, গাড়ির স্পিড কমাও!`);
  msg.lang="bn-BD"; speechSynthesis.speak(msg);
  if(alertActive) setTimeout(speedAlert,4000);
}

// Graph
function drawGraph(currentSpeed){
  const bar=document.createElement("div");
  bar.classList.add("bar");
  bar.style.height=(currentSpeed*1.2)+"px";
  bar.style.left=graph.clientWidth+"px";
  graph.appendChild(bar);
  bars.push(bar);
  bars.forEach(b=>{
    b.style.left=(parseFloat(b.style.left)-3)+"px";
    if(parseFloat(b.style.left)<-3){ graph.removeChild(b); bars.shift(); }
  });
}

// Select destination on map click
map.on('click',function(e){
  destinationLatLng={lat:e.latlng.lat, lon:e.latlng.lng};
  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline([updatePosition.lastLatLng,destinationLatLng],{color:'lime'}).addTo(map);
  directionText.textContent="Direction: Destination set";
});

</script>
</body>
</html>
