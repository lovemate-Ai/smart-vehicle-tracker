<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fleet Navigation Ultimate ‚Äì by Sobuj</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

<style>
  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    background: #f3f6fa;
  }

  #map {
    height: 100vh;
    width: 100%;
  }

  .dashboard {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 10px 15px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    z-index: 1000;
    text-align: center;
  }

  .dashboard input {
    width: 200px;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 8px;
    outline: none;
  }

  .dashboard button {
    background: #007bff;
    color: white;
    border: none;
    padding: 7px 12px;
    border-radius: 8px;
    cursor: pointer;
  }

  .stats {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    border-radius: 15px;
    padding: 10px 20px;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    z-index: 1000;
    text-align: center;
    line-height: 1.6em;
  }

  .direction-box {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #ffffff;
    border-radius: 12px;
    padding: 10px 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    z-index: 1000;
    text-align: center;
    font-weight: 600;
    width: 90%;
  }

  .leaflet-control-attribution { display: none; }
</style>
</head>
<body>

<div class="dashboard">
  <input id="destination" type="text" placeholder="Enter destination..." />
  <button onclick="setDestination()">Go</button>
</div>

<div id="map"></div>

<div class="stats" id="stats">
  üöÄ Speed: <span id="speed">0</span> km/h | 
  üß≠ Avg: <span id="avg">0</span> | 
  ‚ö° Max: <span id="max">0</span><br>
  üìè Distance: <span id="dist">0</span> km | 
  ‚è± Time: <span id="time">0:00</span>
</div>

<div id="direction" class="direction-box">üìç Waiting for location...</div>

<!-- JS Libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
  let map, marker, routeControl;
  const carIconUrl = "https://i.postimg.cc/3xn9Sd08/car.png";
  const carIcon = L.icon({ iconUrl: carIconUrl, iconSize: [45,45], iconAnchor:[22,22] });
  let startTime = Date.now(), totalDistance = 0, lastPos = null, speedList = [], maxSpeed = 0;
  let userLatLng = null;

  // Initialize Map
  map = L.map('map').setView([23.8103, 90.4125], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  // Fake traffic layer (simulated congestion areas)
  const trafficLayer = L.layerGroup([
    L.circle([23.8103, 90.415], {radius: 400, color:"red", fillOpacity:0.3}),
    L.circle([23.818, 90.41], {radius: 300, color:"orange", fillOpacity:0.3}),
    L.circle([23.805, 90.425], {radius: 300, color:"green", fillOpacity:0.2})
  ]).addTo(map);

  // Voice setup
  function speak(text) {
    if (!window.speechSynthesis) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-US";
    window.speechSynthesis.speak(utter);
  }

  // Geolocation live update
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(updatePosition, err => {
      document.getElementById("direction").innerHTML = "‚ùå Location unavailable!";
    }, { enableHighAccuracy:true });
  }

  function updatePosition(pos) {
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    userLatLng = [lat, lon];

    if (!marker) marker = L.marker(userLatLng, {icon:carIcon}).addTo(map);
    else marker.setLatLng(userLatLng);

    map.setView(userLatLng, 16);

    // Distance calculation
    if (lastPos) {
      const dist = map.distance(lastPos, userLatLng) / 1000;
      totalDistance += dist;
    }
    lastPos = userLatLng;

    // Speed (m/s to km/h)
    const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : 0;
    if (speed > 0) speedList.push(parseFloat(speed));
    if (speed > maxSpeed) maxSpeed = speed;

    const avgSpeed = speedList.length ? 
      (speedList.reduce((a,b)=>a+b,0)/speedList.length).toFixed(1) : 0;
    const elapsed = Math.floor((Date.now() - startTime)/1000);
    const minutes = Math.floor(elapsed/60);
    const seconds = elapsed % 60;

    // Update stats
    document.getElementById("speed").innerText = speed;
    document.getElementById("avg").innerText = avgSpeed;
    document.getElementById("max").innerText = maxSpeed;
    document.getElementById("dist").innerText = totalDistance.toFixed(2);
    document.getElementById("time").innerText = `${minutes}:${seconds.toString().padStart(2,'0')}`;

    document.getElementById("direction").innerHTML = `üìç Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
  }

  // Destination routing
  function setDestination() {
    const place = document.getElementById("destination").value.trim();
    if (!place || !userLatLng) {
      alert("Enter a destination & enable GPS.");
      return;
    }

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${place}`)
      .then(res => res.json())
      .then(data => {
        if (!data.length) return alert("Destination not found!");
        const destLat = data[0].lat, destLon = data[0].lon;
        showRoute(userLatLng, [destLat, destLon]);
      });
  }

  function showRoute(start, end) {
    if (routeControl) map.removeControl(routeControl);
    routeControl = L.Routing.control({
      waypoints: [L.latLng(start[0], start[1]), L.latLng(end[0], end[1])],
      lineOptions: { styles:[{color:'blue', opacity:0.8, weight:6}] },
      addWaypoints: false,
      routeWhileDragging: false,
      showAlternatives: false,
      createMarker: () => null
    })
    .on('routesfound', e => {
      const summary = e.routes[0].summary;
      const dist = (summary.totalDistance/1000).toFixed(2);
      const time = (summary.totalTime/60).toFixed(0);
      document.getElementById("direction").innerHTML =
        `üõ£ Route: ${dist} km, ‚è± ${time} min<br>Follow blue line`;
      speak(`Route found. Distance ${dist} kilometers. Estimated time ${time} minutes.`);
    })
    .addTo(map);
  }
</script>
</body>
</html>
