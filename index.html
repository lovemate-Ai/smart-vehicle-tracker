<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Navigator ‚Äì Final Ultra+ Edition</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

<style>
body{margin:0;font-family:'Poppins',sans-serif;background:#111;color:#fff;overflow:hidden}
header{background:#000;color:#0ff;text-align:center;padding:10px;font-size:20px;font-weight:bold}
#map{height:45vh;width:100%}
.stats{display:flex;justify-content:space-around;background:#1a1a1a;padding:10px;font-size:13px;flex-wrap:wrap}
.stats div{text-align:center;margin:5px}
#status{text-align:center;font-weight:bold;color:lime;padding:5px}
#controls{display:flex;justify-content:space-around;padding:10px;flex-wrap:wrap}
input,button{padding:8px;border-radius:10px;border:none;outline:none;font-weight:bold;margin:3px}
button{background:#0b84ff;color:white}
button:hover{background:#0070e0}
#speedGraph{height:100px;width:100%;background:#222;margin-top:5px}
canvas{width:100%;height:100%}
</style>
</head>
<body>

<header>üöò Smart Navigator ‚Äì Final Ultra+ Edition</header>

<div id="map"></div>

<div class="stats">
  <div>Speed: <span id="speed">0.000</span> km/h</div>
  <div>Distance: <span id="distance">0.000</span> km</div>
  <div>ETA: <span id="eta">--:--</span></div>
  <div>Fuel Cost: <span id="fuelCost">0.00</span> ‡ß≥</div>
</div>

<div id="status">üü¢ Efficient Driving</div>

<div id="controls">
  <input type="text" id="destination" placeholder="‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø (‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ lat,long)" />
  <input type="number" id="mileage" placeholder="‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶∞ Mileage km/l" />
  <input type="number" id="fuelPrice" placeholder="Fuel Price /liter ‡ß≥" />
  <input type="number" id="speedLimit" placeholder="Speed Limit km/h" />
  <button id="searchBtn">üîç Search</button>
  <button id="resetBtn">üîÑ Reset</button>
</div>

<div id="speedGraph"><canvas id="graphCanvas"></canvas></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
let username = prompt("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:") || "Driver";

let map, marker, destMarker, routeControl;
let totalDist=0,maxSpeed=0,smoothSpeed=0,lastLat=null,lastLng=null;
let speedHistory=[];
const speedText=document.getElementById("speed");
const distanceText=document.getElementById("distance");
const etaText=document.getElementById("eta");
const statusText=document.getElementById("status");
const fuelCostText=document.getElementById("fuelCost");
const graphCanvas=document.getElementById("graphCanvas");
const ctx=graphCanvas.getContext("2d");

function speak(text){
  let msg=new SpeechSynthesisUtterance(text);
  msg.lang="bn-BD";
  window.speechSynthesis.speak(msg);
}

function initMap(lat,lng){
  map=L.map('map').setView([lat,lng],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  marker=L.marker([lat,lng]).addTo(map);
  map.on('click',e=>setDestination(e.latlng.lat,e.latlng.lng));
}

function setDestination(lat,lng){
  if(destMarker) map.removeLayer(destMarker);
  destMarker=L.marker([lat,lng]).addTo(map).bindPopup("‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø").openPopup();
  if(routeControl) map.removeControl(routeControl);

  routeControl=L.Routing.control({
    waypoints:[L.latLng(lastLat,lastLng),L.latLng(lat,lng)],
    lineOptions:{styles:[{color:'lime',weight:5}]},
    createMarker:()=>null,
    routeWhileDragging:false,
    show:false
  }).addTo(map);

  routeControl.on('routesfound',function(e){
    let route=e.routes[0];
    let eta=(route.summary.totalTime/60).toFixed(1);
    let dist=(route.summary.totalDistance/1000).toFixed(2);
    etaText.innerText=`${eta} min (${dist} km)`;
    speak(`‡¶è‡¶á ${username}, ${dist} ‡¶ï‡¶ø‡¶≤‡ßã‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø‡•§ ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ${eta} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá‡•§`);
  });
}

function smoothValue(oldVal,newVal,factor=0.3){return oldVal+(newVal-oldVal)*factor;}

function updateStats(pos){
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;
  let speed=(pos.coords.speed||0)*3.6;
  if(speed<0.5) speed=0; // fix small GPS noise
  smoothSpeed=smoothValue(smoothSpeed,speed);

  if(lastLat){
    let dist=getDistance(lastLat,lastLng,lat,lng);
    if(dist<1) totalDist+=dist;
  }
  lastLat=lat; lastLng=lng;

  if(smoothSpeed>maxSpeed) maxSpeed=smoothSpeed;
  speedText.innerText=smoothSpeed.toFixed(3);
  distanceText.innerText=totalDist.toFixed(3);
  marker.setLatLng([lat,lng]);
  map.setView([lat,lng]);

  updateFuelCost(totalDist);

  // Speed Limit Alert
  const speedLimit=parseFloat(document.getElementById("speedLimit").value)||60;
  if(smoothSpeed>speedLimit){
    speak(`‡¶è‡¶á ${username}, ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶∞ ‡¶∏‡ßç‡¶™‡¶ø‡¶° ‡¶ï‡¶Æ‡¶æ‡¶ì!`);
    statusText.innerText="üî¥ Over Speed!";
    statusText.style.color="red";
  } else {
    statusText.innerText="üü¢ Efficient Driving";
    statusText.style.color="lime";
  }

  // Update speed history
  speedHistory.push(smoothSpeed);
  if(speedHistory.length>60) speedHistory.shift();
  drawGraph();
}

function drawGraph(){
  ctx.clearRect(0,0,graphCanvas.width,graphCanvas.height);
  ctx.beginPath();
  ctx.strokeStyle="#0f0";
  ctx.lineWidth=2;
  let w=graphCanvas.width, h=graphCanvas.height;
  speedHistory.forEach((v,i)=>{
    let x=i*(w/60);
    let y=h-(v/h*100*h/100); // scale
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

function updateFuelCost(dist){
  const mileage=parseFloat(document.getElementById("mileage").value)||12;
  const fuelPrice=parseFloat(document.getElementById("fuelPrice").value)||120;
  const cost=(dist/mileage)*fuelPrice;
  fuelCostText.innerText=cost.toFixed(2);
}

function getDistance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

document.getElementById("searchBtn").onclick=()=>{
  const input=document.getElementById("destination").value.trim();
  if(!input) return alert("‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
  if(input.includes(",")){
    const [lat,lng]=input.split(",");
    setDestination(parseFloat(lat),parseFloat(lng));
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`)
    .then(res=>res.json())
    .then(data=>{
      if(data.length){
        let loc=data[0];
        setDestination(parseFloat(loc.lat),parseFloat(loc.lon));
      } else alert("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
    });
  }
};

document.getElementById("resetBtn").onclick=()=>{
  totalDist=0; smoothSpeed=0; maxSpeed=0; speedHistory=[];
  lastLat=null; lastLng=null;
  speedText.innerText="0.000";
  distanceText.innerText="0.000";
  etaText.innerText="--:--";
  fuelCostText.innerText="0.00";
  statusText.innerText="üü¢ Efficient Driving";
  if(routeControl) map.removeControl(routeControl);
  if(destMarker) map.removeLayer(destMarker);
  speak("‡¶∏‡¶¨ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
  drawGraph();
};

if(navigator.geolocation){
  navigator.geolocation.watchPosition(updateStats,console.error,{enableHighAccuracy:true});
  navigator.geolocation.getCurrentPosition(pos=>initMap(pos.coords.latitude,pos.coords.longitude));
} else alert("GPS ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ ‡¶è‡¶á ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡¶ü‡¶ø‡•§");

</script>
</body>
</html>
