<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NITRO DUEL: 1v1 Multiplayer</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<style>
    :root { --primary: #00e5ff; --secondary: #ff0055; --bg: #121212; --hud-bg: rgba(0,0,0,0.6); }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; user-select: none; touch-action: none; }
    #game-container { position: relative; width: 100%; height: 100%; }
    canvas { display: block; width: 100%; height: 100%; }
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.85); color: white; z-index: 10; }
    .hidden { display: none !important; }
    h1 { font-size: 3rem; text-transform: uppercase; letter-spacing: 5px; color: var(--primary); text-shadow: 0 0 20px var(--primary); font-style: italic; }
    input { padding: 15px; font-size: 1.2rem; border-radius: 5px; border: 2px solid var(--primary); background: #000; color: white; text-align: center; margin-bottom: 20px; outline: none; }
    button { padding: 15px 50px; font-size: 1.5rem; font-weight: bold; background: linear-gradient(45deg, var(--primary), #0099cc); border: none; border-radius: 5px; cursor: pointer; transition: transform 0.1s; }
    button:active { transform: scale(0.95); }
    #hud { pointer-events: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .top-bar { display: flex; justify-content: space-between; padding: 20px; font-size: 1.5rem; font-weight: bold; color: white; }
    .stat-box { background: var(--hud-bg); padding: 5px 15px; border-left: 4px solid var(--primary); }
    .center-msg { position: absolute; top: 30%; width: 100%; text-align: center; font-size: 4rem; font-weight: 900; color: #fff; text-shadow: 0 5px 15px #000; }
    .speedometer { position: absolute; bottom: 20px; right: 20px; text-align: right; color: white; }
    .controls-layer { display: none; position: absolute; bottom: 20px; width: 100%; height: 150px; pointer-events: none; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
    .btn-touch { pointer-events: auto; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 24px; }
    @media (max-width: 1024px) { .controls-layer { display: flex; } }
</style>
</head>
<body>

<div id="game-container">
    <div id="lobby-screen" class="screen">
        <h1>NITRO DUEL</h1>
        <p id="status-msg">Connecting...</p>
        <input type="text" id="player-name" placeholder="PILOT NAME" maxlength="8">
        <button id="find-match-btn" disabled>FIND MATCH</button>
    </div>

    <div id="hud" class="hidden">
        <div class="top-bar">
            <div class="stat-box">POS: <span id="ui-pos">1/2</span></div>
            <div class="stat-box">DIST: <span id="ui-dist">0</span>m</div>
        </div>
        <div id="center-msg" class="center-msg"></div>
        <div class="speedometer">
            <div style="font-size: 4rem; font-style: italic;"><span id="ui-speed">0</span></div>
            <div style="color: var(--primary);">KM/H</div>
        </div>
        <div class="controls-layer">
            <div style="display: flex; gap: 20px; margin-top: 50px;">
                <div class="btn-touch" id="btn-left">â—€</div>
                <div class="btn-touch" id="btn-right">â–¶</div>
            </div>
            <div style="display: flex; gap: 20px; align-items: flex-end;">
                <div class="btn-touch" style="height: 60px; border-color: #f00;" id="btn-brake">ðŸ›‘</div>
                <div class="btn-touch" style="height: 100px; border-color: #0f0;" id="btn-gas">ðŸš€</div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="screen hidden">
        <h1 id="result-title">FINISHED</h1>
        <button onclick="location.reload()">MAIN MENU</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
// --- FIREBASE CONFIG (Restored) ---
const firebaseConfig = {
  apiKey: "AIzaSyDyEV80WZIwZE_7XTbCXOZv6nh5bMpXXhA",
  authDomain: "racing-game-14ba1.firebaseapp.com",
  databaseURL: "https://racing-game-14ba1-default-rtdb.firebaseio.com",
  projectId: "racing-game-14ba1",
  storageBucket: "racing-game-14ba1.firebasestorage.app",
  messagingSenderId: "361538843544",
  appId: "1:361538843544:web:be75f49647b2da97d131ed"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// --- GAME CONSTANTS ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const ROAD_WIDTH = 2000;
const SEGMENT_LENGTH = 200;
const TOTAL_DISTANCE = 50000;
const MAX_SPEED = 12000;
const ACCEL = MAX_SPEED / 5;
const BREAKING = -MAX_SPEED;
const DECEL = -MAX_SPEED / 5;

let gameState = { active: false, started: false, finished: false, lastTime: 0, banners: [] };
let player = { id: null, name: "Player", x: 0, z: 0, speed: 0 };
let opponent = { id: null, x: 0, z: 0, targetX: 0, targetZ: 0, visible: false };
const input = { left: false, right: false, gas: false, brake: false };
let lobbyRef, playerRef;

// --- NETWORKING ---
auth.onAuthStateChanged(user => {
    if (user) { 
        player.id = user.uid; 
        document.getElementById('find-match-btn').disabled = false;
        document.getElementById('status-msg').innerText = "Online";
    } else { auth.signInAnonymously(); }
});

document.getElementById('find-match-btn').onclick = () => {
    player.name = document.getElementById('player-name').value || "Racer";
    document.getElementById('find-match-btn').disabled = true;
    db.ref('lobbies').orderByChild('status').equalTo('waiting').limitToFirst(1).once('value', snap => {
        if (snap.exists()) joinLobby(Object.keys(snap.val())[0], 2);
        else createLobby();
    });
};

function createLobby() {
    const id = db.ref('lobbies').push().key;
    lobbyRef = db.ref(`lobbies/${id}`);
    lobbyRef.set({ status: 'waiting', host: player.id });
    joinLobby(id, 1);
    lobbyRef.child('players').on('child_added', snap => { if(snap.key !== player.id) startCountdown(); });
}

function joinLobby(id, lane) {
    player.x = lane === 1 ? -0.5 : 0.5;
    lobbyRef = db.ref(`lobbies/${id}`);
    playerRef = lobbyRef.child(`players/${player.id}`);
    playerRef.set({ name: player.name, x: player.x, z: 0, speed: 0 });
    playerRef.onDisconnect().remove();

    lobbyRef.child('status').on('value', snap => {
        if (snap.val() === 'starting') {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
        }
    });

    lobbyRef.child('players').on('value', snap => {
        const p = snap.val();
        for (let id in p) {
            if (id !== player.id) {
                opponent.targetX = p[id].x;
                opponent.targetZ = p[id].z;
                opponent.visible = true;
            }
        }
    });
}

function startCountdown() {
    lobbyRef.update({ status: 'starting' });
    let count = 3;
    const msg = document.getElementById('center-msg');
    const timer = setInterval(() => {
        msg.innerText = count > 0 ? count : "GO!";
        if (count < 0) { 
            gameState.active = gameState.started = true; 
            clearInterval(timer); 
            setTimeout(() => msg.innerText = "", 1000); 
        }
        count--;
    }, 1000);
}

// --- ENGINE ---
function update(dt) {
    let accel = input.gas ? ACCEL : (input.brake ? BREAKING : DECEL);
    player.speed = Math.max(0, Math.min(player.speed + accel * dt, MAX_SPEED));
    player.z += player.speed * dt;
    if (player.speed > 0) {
        if (input.left) player.x -= 1.5 * dt;
        if (input.right) player.x += 1.5 * dt;
    }
    
    // Smooth Opponent Movement (Interpolation)
    opponent.x += (opponent.targetX - opponent.x) * 0.15;
    opponent.z += (opponent.targetZ - opponent.z) * 0.15;

    document.getElementById('ui-speed').innerText = Math.floor(player.speed / 100);
    document.getElementById('ui-dist').innerText = Math.max(0, Math.floor((TOTAL_DISTANCE - player.z)/100));
    document.getElementById('ui-pos').innerText = (player.z >= opponent.z) ? "1/2" : "2/2";

    if (player.z >= TOTAL_DISTANCE && !gameState.finished) {
        gameState.finished = true;
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('result-title').innerText = player.z >= opponent.z ? "VICTORY!" : "2ND PLACE";
    }

    if (playerRef) playerRef.update({ x: player.x, z: player.z, speed: player.speed });
}

function render() {
    ctx.fillStyle = "#2b1640"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    const camZ = player.z;
    const fov = 100, camH = 1000;

    function project(x, y, z) {
        const sc = fov / (z - camZ);
        return { x: canvas.width/2 + (x * 1000) * sc, y: canvas.height/2 + camH * sc, sc, w: 2000 * sc };
    }

    // Ground & Road
    ctx.fillStyle = "#163316"; ctx.fillRect(0, canvas.height/2, canvas.width, canvas.height/2);
    for (let i = 0; i < 100; i++) {
        let z = Math.floor(camZ/200)*200 + i*200;
        if (z < camZ) continue;
        let p1 = project(-1, 0, z), p2 = project(-1, 0, z + 200);
        ctx.fillStyle = (Math.floor(z/200)%2) ? "#333" : "#444";
        ctx.beginPath();
        ctx.moveTo(p1.x - p1.w/2, p1.y); ctx.lineTo(p1.x + p1.w/2, p1.y);
        ctx.lineTo(p2.x + p2.w/2, p2.y); ctx.lineTo(p2.x - p2.w/2, p2.y);
        ctx.fill();
    }

    // Cars
    if (opponent.visible) {
        let op = project(opponent.x, 0, opponent.z);
        drawCar(op.x, op.y, op.sc, "#ff0055");
    }
    drawCar(canvas.width/2 + (player.x * canvas.width * 0.3), canvas.height - 100, 1, "#00e5ff");
}

function drawCar(x, y, sc, col) {
    ctx.fillStyle = col;
    ctx.fillRect(x - 60*sc, y - 40*sc, 120*sc, 40*sc);
    ctx.fillStyle = "#000";
    ctx.fillRect(x - 50*sc, y - 50*sc, 100*sc, 20*sc); // Roof
}

function loop(t) {
    let dt = (t - gameState.lastTime)/1000;
    gameState.lastTime = t;
    if (gameState.active) update(dt || 0);
    render();
    requestAnimationFrame(loop);
}

window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
window.dispatchEvent(new Event('resize'));
requestAnimationFrame(loop);

// Input
const k = (e, v) => {
    if (e.key === 'w' || e.key === 'ArrowUp') input.gas = v;
    if (e.key === 's' || e.key === 'ArrowDown') input.brake = v;
    if (e.key === 'a' || e.key === 'ArrowLeft') input.left = v;
    if (e.key === 'd' || e.key === 'ArrowRight') input.right = v;
};
window.onkeydown = e => k(e, true); window.onkeyup = e => k(e, false);

function bind(id, key) {
    const el = document.getElementById(id);
    el.ontouchstart = e => { e.preventDefault(); input[key] = true; };
    el.ontouchend = e => { e.preventDefault(); input[key] = false; };
}
bind('btn-left', 'left'); bind('btn-right', 'right'); bind('btn-gas', 'gas'); bind('btn-brake', 'brake');

function playTone(f, d) {
    const o = actx.createOscillator(); const g = actx.createGain();
    o.frequency.value = f; o.connect(g); g.connect(actx.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.00001, actx.currentTime + d); o.stop(actx.currentTime + d);
}
const actx = new (window.AudioContext || window.webkitAudioContext)();
</script>
</body>
</html>
