<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live GPS Tracker & Voice Directions</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<style>
  body, html { margin:0; padding:0; height:100%; font-family:system-ui; }
  #map { height: 70%; }
  .stats { padding:10px; background:#f0f4ff; display:flex; flex-wrap:wrap; gap:10px; }
  .stat-box { flex:1; min-width:120px; background:white; padding:10px; border-radius:10px; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
  .stat-box h4 { margin:5px 0; font-size:14px; color:#333; }
  .stat-box p { margin:0; font-size:18px; font-weight:600; color:#0b2545; }
</style>
</head>
<body>

<div id="map"></div>
<div class="stats">
  <div class="stat-box"><h4>বর্তমান স্পিড</h4><p id="currentSpeed">0 km/h</p></div>
  <div class="stat-box"><h4>অ্যাভারেজ স্পিড</h4><p id="avgSpeed">0 km/h</p></div>
  <div class="stat-box"><h4>ম্যাক্স স্পিড</h4><p id="maxSpeed">0 km/h</p></div>
  <div class="stat-box"><h4>মোট দূরত্ব</h4><p id="totalDist">0 km</p></div>
  <div class="stat-box"><h4>ট্র্যাকিং সময়</h4><p id="elapsed">00:00:00</p></div>
  <div class="stat-box"><h4>বর্তমান লোকেশন</h4><p id="currentLocation">-</p></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
let map = L.map('map').setView([23.8103, 90.4125], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// Car icon
let carIcon = L.icon({
  iconUrl: 'https://i.postimg.cc/3xn9Sd08/car.png',
  iconSize: [40, 40],
  iconAnchor: [20, 20]
});

// Variables
let watchId = null;
let lastPos = null;
let startTime = Date.now();
let totalDist = 0;
let maxSpeed = 0;
let speedSamples = [];
let carMarker = null;
let routeControl = null;

// Simulated traffic congestion layer
let trafficLayer = L.layerGroup([
  L.circle([23.811,90.415], {radius:400, color:"red", fillOpacity:0.3}),
  L.circle([23.805,90.42], {radius:300, color:"orange", fillOpacity:0.3}),
  L.circle([23.815,90.405], {radius:300, color:"green", fillOpacity:0.2})
]).addTo(map);

// Start GPS tracking
function startTracking(){
  if(!navigator.geolocation){alert("জিপিএস সাপোর্ট করে না"); return;}
  watchId = navigator.geolocation.watchPosition(onPos, onErr, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
  startTime = Date.now(); totalDist=0; maxSpeed=0; speedSamples=[]; lastPos=null;
}
startTracking();

// Handle position updates
function onPos(p){
  const lat = p.coords.latitude;
  const lon = p.coords.longitude;
  const t = p.timestamp;

  document.getElementById('currentLocation').innerText = lat.toFixed(5)+', '+lon.toFixed(5);

  if(!carMarker) carMarker = L.marker([lat,lon],{icon:carIcon}).addTo(map);
  else carMarker.setLatLng([lat,lon]);

  if(lastPos){
    const dist = haversine(lastPos.lat,lastPos.lon,lat,lon);
    const dt = (t-lastPos.t)/1000;
    if(dt>0){
      const kmh = dist/(dt/3600);
      totalDist += dist;
      speedSamples.push(kmh);
      if(kmh>maxSpeed) maxSpeed=kmh;
      document.getElementById('currentSpeed').innerText = kmh.toFixed(1)+' km/h';
      let avg = speedSamples.reduce((a,b)=>a+b,0)/speedSamples.length;
      document.getElementById('avgSpeed').innerText = avg.toFixed(1)+' km/h';
      document.getElementById('maxSpeed').innerText = maxSpeed.toFixed(1)+' km/h';
      document.getElementById('totalDist').innerText = totalDist.toFixed(3)+' km';
      document.getElementById('elapsed').innerText = msToTime(Date.now()-startTime);
    }
  }
  lastPos={lat, lon, t};

  // Auto-center
  map.setView([lat,lon]);

  // Update route if destination exists
  if(routeControl) routeControl.spliceWaypoints(0,1,L.latLng(lat,lon));
}

// Destination selection on map click
map.on('click', function(e){
  const destination = e.latlng;
  if(routeControl) map.removeControl(routeControl);
  routeControl = L.Routing.control({
    waypoints: [carMarker.getLatLng(), destination],
    routeWhileDragging: true,
    lineOptions: {styles:[{color:'blue', opacity:0.8, weight:5}]},
    createMarker: () => null
  })
  .on('routesfound', function(e){
    const instrs = e.routes[0].instructions;
    instrs.forEach(inst=>{
      const utterance = new SpeechSynthesisUtterance(inst.text);
      utterance.lang = 'bn-BD';
      window.speechSynthesis.speak(utterance);
    });
  })
  .addTo(map);
});

// Haversine formula
function haversine(lat1, lon1, lat2, lon2){
  const R=6371;
  const toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1);
  const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

// Convert ms to hh:mm:ss
function msToTime(ms){
  const s=Math.floor(ms/1000)%60;
  const m=Math.floor(ms/60000)%60;
  const h=Math.floor(ms/3600000);
  return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}

// Error
function onErr(e){console.error(e);}
</script>

</body>
</html>
