<!DOCTYPE html>
<html>
<head>
  <title>Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { display:flex; flex-direction:column; align-items:center; font-family:Arial; }
    video { width:45%; border-radius:10px; margin:5px; }
    button { padding:10px 20px; margin:5px; cursor:pointer; }
    @media(max-width:600px){ video{width:90%;} }
  </style>
</head>
<body>
  <h2>Video Call Demo</h2>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  <div>
    <button id="startCall">Start Call</button>
    <button id="answerCall">Answer Call</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.17.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.17.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
  apiKey: "AIzaSyCNNNQqwowO4OuxW2yjKvMpI-edMolKMy0",
  authDomain: "smart-veichle-tracker.firebaseapp.com",
  projectId: "smart-veichle-tracker",
  storageBucket: "smart-veichle-tracker.firebasestorage.app",
  messagingSenderId: "384592713965",
  appId: "1:384592713965:web:5a530662a268c4096594e4"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const startButton = document.getElementById('startCall');
    const answerButton = document.getElementById('answerCall');

    let localStream;
    let pc;
    const callDoc = doc(collection(db, "calls")); 

    const servers = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        // প্রোডাকশনে TURN সার্ভার ব্যবহার করুন
      ]
    };

    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      localVideo.srcObject = localStream;
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = event => remoteVideo.srcObject = event.streams[0];

      // ICE candidates send
      pc.onicecandidate = event => {
        if(event.candidate){
          const cand = event.candidate.toJSON();
          setDoc(callDoc, { iceCandidates: [...(callDoc.iceCandidates||[]), cand] }, { merge:true });
        }
      };
    }

    startButton.onclick = async () => {
      createPeerConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await setDoc(callDoc, { offer: offer });

      // Listen for answer & ICE candidates
      onSnapshot(callDoc, snapshot => {
        const data = snapshot.data();
        if(data?.answer && !pc.currentRemoteDescription){
          pc.setRemoteDescription(data.answer);
        }
        if(data?.iceCandidates){
          data.iceCandidates.forEach(c => pc.addIceCandidate(c));
        }
      });
    };

    answerButton.onclick = async () => {
      createPeerConnection();
      const callData = (await getDoc(callDoc)).data();
      await pc.setRemoteDescription(callData.offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await setDoc(callDoc, { answer: answer }, { merge:true });
    };

    initMedia();
  </script>
</body>
</html>

